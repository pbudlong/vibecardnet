# SDK Reference

This document covers all primitives exported by `@circlefin/x402-batching`.

---

## Table of Contents

- [High-Level APIs](#high-level-apis)
  - [GatewayClient (Buyer)](#gatewayclient)
  - [createGatewayMiddleware (Seller)](#creategatewaymiddleware)
- [Protocol Integration](#protocol-integration)
  - [BatchEvmScheme](#batchevmscheme)
  - [BatchFacilitatorClient](#batchfacilitatorclient)
  - [registerBatchScheme](#registerbatchscheme)
- [Utilities](#utilities)
  - [supportsBatching](#supportsbatching)
  - [isBatchPayment](#isbatchpayment)
  - [getVerifyingContract](#getverifyingcontract)
- [Configuration](#configuration)
  - [Chain Configuration](#chain-configuration)
  - [Constants](#constants)

---

## High-Level APIs

### `GatewayClient`

**Import:** `import { GatewayClient } from '@circlefin/x402-batching/client'`

Primary client for buyers to interact with Circle Gateway. Handles deposits, payments, and withdrawals.

#### Constructor

```typescript
new GatewayClient(config: GatewayClientConfig)
```

| Parameter           | Type                 | Required | Description                                                 |
| ------------------- | -------------------- | -------- | ----------------------------------------------------------- |
| `config.chain`      | `SupportedChainName` | ✓        | Chain to connect to (e.g., `'baseSepolia'`, `'arcTestnet'`) |
| `config.privateKey` | `Hex`                | ✓        | Private key for signing (`'0x...'`)                         |
| `config.rpcUrl`     | `string`             |          | Optional custom RPC URL                                     |

#### Properties

| Property       | Type           | Description                  |
| -------------- | -------------- | ---------------------------- |
| `address`      | `Address`      | The account's wallet address |
| `chainName`    | `string`       | Human-readable chain name    |
| `domain`       | `number`       | Gateway domain identifier    |
| `publicClient` | `PublicClient` | Viem public client           |
| `walletClient` | `WalletClient` | Viem wallet client           |

#### Methods

##### `deposit(amount, options?): Promise<DepositResult>`

Deposits USDC from your wallet into the Gateway contract.

| Parameter               | Type     | Required | Description                              |
| ----------------------- | -------- | -------- | ---------------------------------------- |
| `amount`                | `string` | ✓        | Amount in decimal (e.g., `"10.5"`)       |
| `options.approveAmount` | `string` |          | Amount to approve (defaults to `amount`) |

##### `pay<T>(url, options?): Promise<PayResult<T>>`

Pays for an x402-protected resource. Handles the 402 flow automatically.

| Parameter | Type          | Required | Description                                    |
| --------- | ------------- | -------- | ---------------------------------------------- |
| `url`     | `string`      | ✓        | URL to pay for                                 |
| `options` | `RequestInit` |          | Standard fetch options (method, body, headers) |

##### `withdraw(amount, options?): Promise<WithdrawResult>`

Withdraws USDC from Gateway to your wallet. Supports same-chain or cross-chain withdrawals.

| Parameter           | Type                 | Required | Description                               |
| ------------------- | -------------------- | -------- | ----------------------------------------- |
| `amount`            | `string`             | ✓        | Amount in decimal                         |
| `options.chain`     | `SupportedChainName` |          | Destination chain (default: same chain)   |
| `options.recipient` | `Address`            |          | Recipient address (default: your address) |

##### `getBalances(address?): Promise<Balances>`

Returns both wallet USDC balance and Gateway balances.

##### `supports(url): Promise<SupportsResult>`

Checks if a URL supports Gateway batching before paying.

#### Return Types

```typescript
interface DepositResult {
  approvalTxHash?: Hex;
  depositTxHash: Hex;
  amount: bigint;
  formattedAmount: string;
}

interface PayResult<T> {
  data: T;
  amount: bigint;
  formattedAmount: string;
  transaction: string;
  status: number;
}

interface WithdrawResult {
  mintTxHash: Hex;
  amount: bigint;
  formattedAmount: string;
  sourceChain: string;
  destinationChain: string;
  recipient: Address;
}

interface Balances {
  wallet: { balance: bigint; formatted: string };
  gateway: GatewayBalance;
}

interface GatewayBalance {
  total: bigint;
  available: bigint; // Balance usable for payments/withdrawals
  withdrawing: bigint; // Locked in trustless withdrawal
  withdrawable: bigint; // Ready to finalize trustless withdrawal
  formattedTotal: string;
  formattedAvailable: string;
}

interface SupportsResult {
  supported: boolean;
  requirements?: Record<string, unknown>;
  error?: string;
}
```

---

### `createGatewayMiddleware`

**Import:** `import { createGatewayMiddleware } from '@circlefin/x402-batching/server'`

Creates Express-compatible middleware for accepting Gateway payments.

```typescript
createGatewayMiddleware(config: GatewayMiddlewareConfig): GatewayMiddleware
```

#### Configuration

| Parameter       | Type                 | Required | Description                             |
| --------------- | -------------------- | -------- | --------------------------------------- |
| `sellerAddress` | `string`             | ✓        | Your wallet address to receive payments |
| `networks`      | `string \| string[]` |          | Networks to accept (default: all)       |
| `description`   | `string`             |          | Resource description for 402 responses  |

#### Methods

##### `require(price): MiddlewareFunction`

Returns Express middleware that requires payment.

| Parameter | Type     | Description                                |
| --------- | -------- | ------------------------------------------ |
| `price`   | `string` | Price in USD (e.g., `'$0.01'` or `'0.01'`) |

The middleware attaches payment info to `req.payment`:

```typescript
interface PaymentInfo {
  verified: boolean;
  payer: string;
  amount: string;
  network: string;
  transaction?: string;
}
```

---

## Protocol Integration

Low-level classes for integrating with the x402 protocol libraries (`@x402/core`).

### `BatchEvmScheme`

**Import:** `import { BatchEvmScheme } from '@circlefin/x402-batching/client'`

A `SchemeNetworkClient` implementation for Circle Gateway batched payments.

#### Constructor

```typescript
new BatchEvmScheme(signer: BatchEvmSigner)
```

| Parameter | Type             | Description                                   |
| --------- | ---------------- | --------------------------------------------- |
| `signer`  | `BatchEvmSigner` | EVM signer with `address` and `signTypedData` |

#### Methods

##### `createPaymentPayload(x402Version, paymentRequirements): Promise<PaymentPayload>`

Creates a payment payload by signing EIP-3009 `TransferWithAuthorization`.

---

### `BatchFacilitatorClient`

**Import:** `import { BatchFacilitatorClient } from '@circlefin/x402-batching/server'`

A `FacilitatorClient` implementation that communicates with Circle Gateway's x402 endpoints.

#### Constructor

```typescript
new BatchFacilitatorClient(config?: BatchFacilitatorConfig)
```

#### Methods

##### `verify(payload, requirements): Promise<VerifyResponse>`

Verifies a payment signature.

##### `settle(payload, requirements): Promise<SettleResponse>`

Settles a payment.

##### `getSupported(): Promise<SupportedResponse>`

Fetches supported payment kinds (networks and contract addresses).

#### Return Types

```typescript
interface VerifyResponse {
  isValid: boolean;
  invalidReason?: string;
  payer?: string;
}

interface SettleResponse {
  success: boolean;
  errorReason?: string;
  payer?: string;
  transaction: string;
}

interface SupportedResponse {
  kinds: Array<{
    x402Version: number;
    scheme: string;
    network: string;
    extra?: { verifyingContract?: string };
  }>;
}
```

---

### `registerBatchScheme`

**Import:** `import { registerBatchScheme } from '@circlefin/x402-batching/client'`

Helper to register `BatchEvmScheme` with an `x402Client`.

```typescript
registerBatchScheme(client, { signer: account });
```

---

## Utilities

### `supportsBatching`

**Import:** `import { supportsBatching } from '@circlefin/x402-batching'`

Checks if a `PaymentRequirements` object supports batched settlement.

### `isBatchPayment`

**Import:** `import { isBatchPayment } from '@circlefin/x402-batching/server'`

Server-side alias for `supportsBatching`.

### `getVerifyingContract`

**Import:** `import { getVerifyingContract } from '@circlefin/x402-batching'`

Extracts the GatewayWallet address from requirements.

---

## Configuration

### Chain Configuration

**Import:** `import { CHAIN_CONFIGS, GATEWAY_DOMAINS } from '@circlefin/x402-batching/client'`

- **`CHAIN_CONFIGS`**: Full configuration (USDC address, Gateway address, etc.) for all supported chains.
- **`GATEWAY_DOMAINS`**: Domain IDs for EIP-712 signing.

### Constants

**Import:** `import { CIRCLE_BATCHING_NAME, ... } from '@circlefin/x402-batching'`

- `CIRCLE_BATCHING_NAME`: `'GatewayWalletBatched'`
- `CIRCLE_BATCHING_VERSION`: `'1'`
- `CIRCLE_BATCHING_SCHEME`: `'exact'`
