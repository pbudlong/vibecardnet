# Seller Guide: Monetize your API

This guide shows you how to accept gasless USDC payments for your API endpoints.

## Why use this?

1.  **Gasless for Buyers**: Your users don't pay gas fees, increasing conversion rates.
2.  **Instant Liquidity for You**: Get paid on **any chain**. You can withdraw your earnings to supported EVM chain instantly, regardless of where the buyer paid from.

> ⚠️ **Important Notes**
>
> - **x402 Version**: Circle Gateway currently supports **x402 v2**. If you need **v1 support**, please reach out—we are happy to prioritize it based on demand.
> - **Signature Validity**: Payment signatures must have **at least 4 days of validity**. Ensure the `validBefore` timestamp is set to at least 4 days in the future. Signatures with shorter validity periods will be rejected. -**Settlement Priority**: We discourage relying on `verify()` for settlement flows, as the Gateway `settle()` endpoint is optimized for low latency and guarantees settlement. However, if you have specific verification needs, we are happy to discuss your use case.

## 1. Installation

```bash
npm install @circlefin/x402-batching express
```

## 2. The Easy Way (Middleware)

The easiest way to integrate is using our Express middleware. It handles the entire `402 Payment Required` negotiation loop for you.

```typescript
import express from 'express';
import { createGatewayMiddleware } from '@circlefin/x402-batching/server';

const app = express();

// 1. Configure Gateway
// By default, this accepts payments from ALL supported Gateway chains.
const gateway = createGatewayMiddleware({
  sellerAddress: '0xYOUR_WALLET_ADDRESS', // Where you want to receive USDC
});

// 2. Protect a route
// This will automatically return 402 if no payment is provided,
// and 200 (with next()) if a valid payment signature is found.
app.get('/premium-data', gateway.require('$0.01'), (req, res) => {
  // Payment info is attached to the request
  const { payer, amount, network } = req.payment!;

  console.log(`Paid ${amount} USDC by ${payer} on ${network}`);

  res.json({
    secret: 'The treasure is hidden under the doormat.',
    paid_by: payer,
  });
});

app.listen(3000);
```

---

## 3. Advanced Integration

If you aren't using Express, or need complex logic (e.g. dynamic pricing, custom headers), use the `BatchFacilitatorClient`.

```typescript
import { BatchFacilitatorClient } from '@circlefin/x402-batching/server';

const facilitator = new BatchFacilitatorClient();

async function handleRequest(req, res) {
  const signature = req.headers['payment-signature'];

  // Case 1: No Payment provided -> Ask for it
  if (!signature) {
    return res.status(402).json({
      x402Version: 1,
      accepts: [{
        scheme: 'GatewayWalletBatched',
        amount: '10000', // 0.01 USDC (6 decimals)
        payTo: '0xYOUR_ADDRESS',
        // ... see API docs for full object structure
      }]
    });
  }

  // Case 2: Verify Payment
  const payload = JSON.parse(Buffer.from(signature, 'base64').toString());
  const requirements = /* reconstruct your requirements here */;

  // Verify signature
  const verification = await facilitator.verify(payload, requirements);
  if (!verification.isValid) {
    return res.status(402).json({ error: 'Invalid signature' });
  }

  // Settle (Submit to Gateway)
  const settlement = await facilitator.settle(payload, requirements);
  if (!settlement.success) {
    return res.status(402).json({ error: 'Settlement failed' });
  }

  // Success!
  res.json({ data: '...' });
}
```

---

## 4. Customization: Supported Networks

By default, the middleware accepts payments from **any** chain supported by Circle Gateway.

**We recommend keeping the default configuration.** This ensures:

1.  **Maximum Reach**: Any buyer with a Gateway balance can pay you.
2.  **Flexible Liquidity**: You receive USDC in your Gateway balance, which you can withdraw to **any** supported chain instantly.

However, if you strictly need to limit payments to specific networks:

```typescript
const gateway = createGatewayMiddleware({
  sellerAddress: '0x...',
  networks: ['eip155:5042002'], // Only accept Arc Testnet
});
```
